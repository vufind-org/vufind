<?xml version="1.0" encoding="UTF-8"?>
<project name="vufind" basedir="." default="main">
  <property name="sh" value="/bin/sh" />
  <property name="tmp" value="/tmp" />
  <property name="package"  value="${phing.project.name}" override="true" />
  <property name="builddir" value="${tmp}/build/${phing.project.name}" override="true" />
  <property name="srcdir"   value="${project.basedir}" override="true" />
  <property name="downloadsdir" value="${srcdir}/downloads" override="true" />
  <!--
    Use builddir/local as the local directory if defaultconfigs=true. This allows the
    tests to be run without any custom configuration possibly interfering in the
    normal local directory.
  -->
  <if>
    <equals arg1="${defaultconfigs}" arg2="true" />
    <then>
      <property name="localdir" value="${builddir}/local" override="true" />
    </then>
    <else>
      <property name="localdir" value="${srcdir}/local" override="false" />
    </else>
  </if>
  <property name="apacheconfdir" value="/etc/apache2/conf.d" />
  <property name="apachectl" value="" /><!-- set to apachectl path to spin up Apache instance -->
  <property name="seleniumjar" value="" /><!-- set to Selenium jar path to spin up Selenium instance -->
  <!-- command for extra cleanup during shutdown; e.g. to change cache ownership after testing w/ Apache so deletion won't fail: -->
  <property name="extra_startup_command" value="" />
  <property name="extra_shutdown_cleanup" value="" />
  <property name="vufindurl" value="http://localhost/vufind" />
  <property name="vufinddb" value="vufind_test" />
  <property name="vufinddbuser" value="vufindtest" />
  <property name="vufinddbpass" value="vufindtestpass" />
  <property name="dbtype" value="mysql" /><!-- use pgsql for PostgreSQL -->
  <property name="mysqlhost" value="localhost" />
  <property name="mysqlport" value="3306" />
  <property name="mysqlprotocol" value="" />
  <property name="mysqlrootuser" value="root" />
  <property name="mysqlrootpass" value="password" />
  <property name="pgsqlhost" value="localhost" />
  <property name="pgsqlrootuser" value="postgres" />
  <property name="disable_csp" value="false" /> <!-- set value to "true" to disable Content Security Policy -->
  <property name="phpunit_command" value="${srcdir}/vendor/bin/phpunit" />
  <property name="phpunit_extra_params" value="" />
  <property name="composer_version" value="2.7.7" />
  <property name="composer_extra_params" value="" />
  <property name="mink_driver" value="selenium" />
  <property name="screenshot_dir" value="" /><!-- set to a directory name to capture screenshots of failed tests -->
  <property name="selenium_browser" value="firefox" />
  <property name="snooze_multiplier" value="1" /><!-- can be used to slow down Mink tests; increase when tests fail on slow systems -->
  <property name="default_test_timeout" value="5000" /><!-- default timeout (in ms) for Mink tests; increase when tests fail on slow systems -->
  <property name="solr_startup_sleep" value="0" />
  <property name="solr_additional_jvm_options" value="-Dlog4j2.formatMsgNoLookups=true" />
  <property name="solr_version" value="9.5.0" />
  <property name="solr_port" value="8983" />
  <property name="skip_phpdoc" value="false" />
  <property name="phpdoc_version" value="3.3.1" />
  <property name="html_validator" value="" /><!-- set to base address of NU Validator (e.g. http://localhost:8888/) for HTML validation during Mink tests -->
  <property name="html_validator_fail_tests" value="1" /><!-- set to 0 to just log HTML validation errors without causing tests to fail -->
  <property name="html_validator_log_file" value="" /><!-- set to a file name to log HTML validation messages to -->
  <property name="html_validator_quiet" value="" /><!-- set to 1 to prevent the HTML validation from outputting results to the console  -->
  <property name="phpunit_remote_coverage" value="" /><!-- set to 1 to enable code coverage for Mink tests  -->
  <property name="retain_coverage_files" value="false" /><!-- set to true to keep temporary coverage files from Mink tests -->
  <property name="test_theme" value="" /><!-- set to a theme name to override the default theme for Mink tests -->
  <property name="psql_needs_sudo" value="true" /><!-- set to false if psql (Postgresql) must be run with current user instead of sudo -->
  <property name="solr_pid_file" value="${localdir}/solr-${solr_port}.pid" />

  <property name="version" value="10.0" />

  <property name="mysqlconnectionargs" value="-h ${mysqlhost} -P ${mysqlport} -u ${mysqlrootuser}" />
  <!-- Add password if not empty -->
  <if>
    <not>
      <equals arg1="${mysqlrootpass}" arg2="" />
    </not>
    <then>
      <property name="mysqlconnectionargs" override="true" value="${mysqlconnectionargs} -p${mysqlrootpass}" />
    </then>
  </if>
  <!-- Add protocol if not empty -->
  <if>
    <not>
      <equals arg1="${mysqlprotocol}" arg2="" />
    </not>
    <then>
      <property name="mysqlconnectionargs" override="true" value="${mysqlconnectionargs} --protocol ${mysqlprotocol}" />
    </then>
  </if>

  <!-- Main Target -->
  <target name="main" description="main target">
    <phingcall target="startup" />
    <phingcall target="ci-tasks-with-shutdown" />
  </target>

  <!-- Continuous Integration Tasks with guaranteed shutdown -->
  <target name="ci-tasks-with-shutdown" description="continuous integration tasks (with shutdown on success or failure)">
    <trycatch property="exceptionmsg">
      <try>
        <phingcall target="ci-tasks" />
      </try>
      <catch>
        <phingcall target="shutdown" />
        <fail>Unexpected error during continuous integration tasks -- ${exceptionmsg}</fail>
      </catch>
    </trycatch>
    <phingcall target="shutdown" />
  </target>

  <!-- Run tests, shut down if anything fails (useful when chaining multiple phpunitfast runs in continuous
       integration with different settings; e.g. to repeat tests with different themes) -->
  <target name="phpunitfast-with-shutdown-on-fail" description="run phpunitfast task; shutdown if anything fails">
    <trycatch property="exceptionmsg">
      <try>
        <phingcall target="phpunitfast" />
      </try>
      <catch>
        <phingcall target="shutdown" />
        <fail>${exceptionmsg}</fail>
      </catch>
    </trycatch>
  </target>

  <!-- Continuous Integration Tasks -->
  <target name="ci-tasks" description="continuous integration tasks">

    <!-- Create dirs -->
    <mkdir dir="${builddir}/reports"/>
    <mkdir dir="${builddir}/reports/coverage"/>

    <!-- Call standard tasks -->
    <phingcall target="phpcs"/>
    <phingcall target="php-cs-fixer-dryrun"/>
    <phingcall target="phpunit"/>
    <phingcall target="phpdoc"/>
    <phingcall target="phpmd"/>
    <phingcall target="pdepend"/>
    <phingcall target="eslint-report"/>
    <phingcall target="jshint-report"/>
    <phingcall target="phpstan-checkstyle"/>
    <phingcall target="check-bootstrap5"/>
  </target>

  <!-- Quality Assurance Tasks -->
  <target name="qa-console" description="quality assurance tasks">
    <!-- Call standard tasks -->
    <phingcall target="qa-js-and-less"/>
    <phingcall target="qa-php"/>
    <phingcall target="check-bootstrap5"/>
  </target>

  <!-- Quality Assurance Javascript Tasks -->
  <target name="qa-js-and-less" description="quality assurance js and less tasks">
    <phingcall target="eslint"/>
    <phingcall target="jshint"/>
    <phingcall target="checkLessToSass"/>
    <phingcall target="checkSassBuild"/>
  </target>

  <!-- Quality Assurance PHP Tasks -->
  <target name="qa-php" description="quality assurance php tasks">
    <phingcall target="phpunitfast"/>
    <phingcall target="phpcs-console"/>
    <phingcall target="php-cs-fixer-dryrun"/>
    <phingcall target="phpstan-console"/>
  </target>

  <!-- Fix PHP Tasks -->
  <target name="fix-php" description="quality assurance php tasks">
    <phingcall target="php-cs-fixer"/>
    <phingcall target="phpcbf"/>
  </target>

  <!-- Report rule violations with PHPMD (mess detector) -->
  <target name="phpmd">
    <exec executable="${srcdir}/vendor/bin/phpmd">
      <arg line="${srcdir}/module xml ${srcdir}/tests/phpmd.xml --exclude ${srcdir}/module/VuFind/tests,${srcdir}/module/VuFindSearch/tests --reportfile ${builddir}/reports/phpmd.xml" />
    </exec>
  </target>

  <!-- PHP_Depend code analysis -->
  <target name="pdepend">
    <exec executable="${srcdir}/vendor/bin/pdepend">
      <arg line="--jdepend-xml=${builddir}/reports/jdepend.xml --jdepend-chart=${builddir}/reports/dependencies.svg --overview-pyramid=${builddir}/reports/pdepend-pyramid.svg ${srcdir}/module" />
    </exec>
  </target>

  <!-- PHP CodeSniffer -->
  <target name="phpcbf">
    <!-- Run phpcs first to find any problems (faster than phpcbf): -->
    <exec executable="${srcdir}/vendor/bin/phpcs" escape="false" returnProperty="phpcs_retval" outputProperty="phpcs_output">
      <arg line="--cache=${srcdir}/tests/phpcs.cache.json --standard=${srcdir}/tests/phpcs.xml" />
    </exec>
    <if>
      <not><equals arg1="${phpcs_retval}" arg2="0" /></not>
      <then>
        <echo msg="Trying to fix the following issues: " />
        <echo msg="${phpcs_output}" />
        <!-- Extract file names from phpcs output: -->
        <property name="phpcbf_filelist" value="${phpcs_output}">
          <filterchain>
            <linecontainsregexp>
              <regexp pattern="^FILE: (.*)" />
            </linecontainsregexp>
            <striplinebreaks />
            <replaceregexp>
              <regexp pattern="FILE: " replace=" " />
            </replaceregexp>
          </filterchain>
        </property>
        <!-- Finally, run phpcbf: -->
        <exec executable="${srcdir}/vendor/bin/phpcbf" escape="false" passthru="true">
          <arg line="--standard=${srcdir}/tests/phpcs.xml ${phpcbf_filelist}" />
        </exec>
      </then>
    </if>
  </target>
  <target name="phpcs">
    <exec executable="${srcdir}/vendor/bin/phpcs" escape="false">
      <arg line="--cache=${srcdir}/tests/phpcs.cache.json --standard=${srcdir}/tests/phpcs.xml --report=checkstyle &gt; ${builddir}/reports/checkstyle.xml" />
    </exec>
  </target>
  <target name="phpcs-console">
    <exec executable="${srcdir}/vendor/bin/phpcs" escape="false" passthru="true" checkreturn="true">
      <arg line="--cache=${srcdir}/tests/phpcs.cache.json --standard=${srcdir}/tests/phpcs.xml" />
    </exec>
  </target>

  <!-- Phpstan -->
  <target name="phpstan-checkstyle">
    <exec executable="${srcdir}/vendor/bin/phpstan" escape="false" passthru="true" checkreturn="true">
      <arg line="--configuration=${srcdir}/tests/phpstan.neon --memory-limit=2G --error-format=checkstyle analyse &gt; ${builddir}/reports/phpstan-checkstyle.xml" />
    </exec>
  </target>
  <target name="phpstan-console">
    <exec executable="${srcdir}/vendor/bin/phpstan" escape="false" passthru="true" checkreturn="true">
      <arg line="--configuration=${srcdir}/tests/phpstan.neon --memory-limit=2G analyse" />
    </exec>
  </target>

  <!-- php-cs-fixer (first task applies fixes, second task simply checks if they are needed) -->
  <target name="php-cs-fixer">
    <exec executable="${srcdir}/vendor/bin/php-cs-fixer" passthru="true" escape="false">
      <arg line="fix --config=${srcdir}/tests/vufind.php-cs-fixer.php -vvv" />
    </exec>
    <exec executable="${srcdir}/vendor/bin/php-cs-fixer" passthru="true" escape="false">
      <arg line="fix --config=${srcdir}/tests/vufind_templates.php-cs-fixer.php -vvv" />
    </exec>
  </target>
  <target name="php-cs-fixer-dryrun">
    <exec executable="${srcdir}/vendor/bin/php-cs-fixer" passthru="true" escape="false" checkreturn="true">
      <arg line="fix --config=${srcdir}/tests/vufind.php-cs-fixer.php --dry-run -vvv --diff" />
    </exec>
    <exec executable="${srcdir}/vendor/bin/php-cs-fixer" passthru="true" escape="false" checkreturn="true">
      <arg line="fix --config=${srcdir}/tests/vufind_templates.php-cs-fixer.php --dry-run -vvv --diff" />
    </exec>
  </target>

  <!-- ESLint -->
  <target name="eslint">
    <exec executable="npx" escape="false" checkreturn="true" passthru="true">
      <arg line="eslint ${srcdir}/themes/**/*.js -c ${srcdir}/.eslintrc.js" />
    </exec>
  </target>
  <target name="eslint-fix">
    <exec executable="npx" escape="false" passthru="true">
      <arg line="eslint ${srcdir}/themes/**/*.js -c ${srcdir}/.eslintrc.js --fix" />
    </exec>
  </target>
  <target name="eslint-report">
    <exec executable="npx" escape="false">
      <arg line="eslint ${srcdir}/themes/**/*.js -c ${srcdir}/.eslintrc.js --format checkstyle -o ${builddir}/reports/eslint-checkstyle.xml" />
    </exec>
  </target>

  <!-- JSHint -->
  <target name="jshint">
    <exec executable="npx" checkreturn="true" passthru="true">
      <arg line="jshint --config=${srcdir}/tests/jshint.json --exclude=themes/*/js/vendor,themes/*/node_modules ${srcdir}/themes" />
    </exec>
  </target>
  <target name="jshint-report">
    <exec executable="npx">
      <arg line="jshint --config=${srcdir}/tests/jshint.json --exclude=themes/*/js/vendor,themes/*/node_modules --reporter=checkstyle ${srcdir}/themes &gt; ${builddir}/reports/jshint-checkstyle.xml" />
    </exec>
  </target>

  <!-- Run Sass build, error if it fails -->
  <target name="checkSassBuild">
    <exec executable="npm" checkreturn="true" passthru="true">
      <arg line="run check:scss" />
    </exec>
  </target>

  <!-- Run LessToSass, error if there are uncommitted changes (used by continuous integration) -->
  <target name="checkLessToSass">
    <exec executable="npm" checkreturn="true" passthru="true">
      <arg line="run lessToSass" />
    </exec>
    <exec executable="git" checkreturn="true" passthru="true">
      <arg line="diff --exit-code *.scss" />
    </exec>
  </target>

  <!-- PHP API Documentation -->
  <target name="phpdoc">
    <!-- Skip the whole phpdoc task when disabled -->
    <if>
      <not><equals arg1="${skip_phpdoc}" arg2="true" /></not>
      <then>
        <!-- GET phpDocumentor.phar -->
        <if>
          <not><available file="${srcdir}/vendor/bin/phpDocumentor-${phpdoc_version}.phar" /></not>
          <then>
            <httpget followRedirects="true" url="https://github.com/phpDocumentor/phpDocumentor2/releases/download/v${phpdoc_version}/phpDocumentor.phar" dir="${srcdir}/vendor/bin" filename="phpDocumentor-${phpdoc_version}.phar" />
            <chmod mode="0755">
              <fileset dir="${srcdir}/vendor/bin">
                <include name="phpDocumentor-${phpdoc_version}.phar" />
              </fileset>
            </chmod>
          </then>
        </if>
        <!-- Run phpdoc -->
        <mkdir dir="${builddir}/apidocs" />
        <mkdir dir="${builddir}/docs_cache" />
        <!-- Old embedded version; no longer works correctly...
        <phpdoc2 title="VuFind API Documentation"
          pharlocation="${srcdir}/vendor/bin/phpDocumentor-${phpdoc_version}.phar"
          destdir="${builddir}/apidocs">
          <fileset dir=".">
            <include name="module/*/src/**/*.php" />
          </fileset>
        </phpdoc2>
        -->
        <exec executable="php" passthru="true">
          <arg line="${srcdir}/vendor/bin/phpDocumentor-${phpdoc_version}.phar --cache-folder=${builddir}/docs_cache --title=&quot;VuFind API Documentation&quot; -t ${builddir}/apidocs -d ${srcdir}/module" />
        </exec>
      </then>
    </if>
  </target>

  <!-- PHPUnit -->
  <target name="phpunit" description="Run tests">
    <!-- Clean up any previous tmp files but keep the directory if it exists to avoid changing its permissions -->
    <property name="coveragedir" value="${builddir}/reports/coverage" />
    <if>
      <available file="${coveragedir}/tmp" type="dir" />
      <then>
        <delete>
          <fileset dir="${coveragedir}/tmp">
            <include name="**/*" />
          </fileset>
        </delete>
      </then>
      <else>
        <mkdir dir="${coveragedir}/tmp" />
      </else>
    </if>

    <!-- Run tests -->
    <if>
      <istrue value="${phpunit_remote_coverage}" />
      <then>
        <property name="remote_coverage_dir" value="${coveragedir}/tmp" />
      </then>
      <else>
        <property name="remote_coverage_dir" value="" />
      </else>
    </if>
    <exec dir="${srcdir}/module/VuFind/tests" executable="${sh}" passthru="true" checkreturn="true">
      <arg line="-c &apos;${phpunit_command} --log-junit ${builddir}/reports/phpunit.xml --coverage-php ${coveragedir}/tmp/unit.cov ${phpunit_extra_params}&apos;" />
      <env key="XDEBUG_MODE" value="coverage" />
      <env key="VUFIND_MINK_DRIVER" value="${mink_driver}" />
      <env key="VUFIND_SCREENSHOT_DIR" value="${screenshot_dir}" />
      <env key="VUFIND_HTML_VALIDATOR" value="${html_validator}" />
      <env key="VUFIND_HTML_VALIDATOR_FAIL_TESTS" value="${html_validator_fail_tests}" />
      <env key="VUFIND_HTML_VALIDATOR_LOG_FILE" value="${html_validator_log_file}" />
      <env key="VUFIND_HTML_VALIDATOR_QUIET" value="${html_validator_quiet}" />
      <env key="VUFIND_SELENIUM_BROWSER" value="${selenium_browser}" />
      <env key="VUFIND_SNOOZE_MULTIPLIER" value="${snooze_multiplier}" />
      <env key="VUFIND_DEFAULT_TEST_TIMEOUT" value="${default_test_timeout}" />
      <env key="VUFIND_LOCAL_DIR" value="${localdir}" />
      <env key="VUFIND_URL" value="${vufindurl}" />
      <env key="VUFIND_TEST_THEME" value="${test_theme}" />
      <env key="SOLR_PORT" value="${solr_port}" />
      <env key="VUFIND_REMOTE_COVERAGE_DIR" value="${remote_coverage_dir}" />
    </exec>

    <!-- Produce coverage reports -->
    <exec executable="${srcdir}/vendor/bin/phpcov" passthru="true" checkreturn="true">
      <arg line="merge --clover ${coveragedir}/clover.xml --html ${coveragedir} ${coveragedir}/tmp" />
    </exec>

    <!-- Clean up any tmp files unless told not to, but keep the directory to avoid changing its permissions -->
    <if>
      <isfalse value="${retain_coverage_files}" />
      <then>
        <delete>
          <fileset dir="${coveragedir}/tmp">
            <include name="**/*" />
          </fileset>
        </delete>
      </then>
    </if>
  </target>

  <!-- PHPUnit without logging output -->
  <target name="phpunitfast" description="Run tests">
    <exec dir="${srcdir}/module/VuFind/tests" executable="${sh}" passthru="true" checkreturn="true">
      <arg line="-c &apos;${phpunit_command} ${phpunit_extra_params}&apos;" />
      <env key="VUFIND_MINK_DRIVER" value="${mink_driver}" />
      <env key="VUFIND_SCREENSHOT_DIR" value="${screenshot_dir}" />
      <env key="VUFIND_HTML_VALIDATOR" value="${html_validator}" />
      <env key="VUFIND_HTML_VALIDATOR_FAIL_TESTS" value="${html_validator_fail_tests}" />
      <env key="VUFIND_HTML_VALIDATOR_LOG_FILE" value="${html_validator_log_file}" />
      <env key="VUFIND_HTML_VALIDATOR_QUIET" value="${html_validator_quiet}" />
      <env key="VUFIND_SELENIUM_BROWSER" value="${selenium_browser}" />
      <env key="VUFIND_SNOOZE_MULTIPLIER" value="${snooze_multiplier}" />
      <env key="VUFIND_DEFAULT_TEST_TIMEOUT" value="${default_test_timeout}" />
      <env key="VUFIND_LOCAL_DIR" value="${localdir}" />
      <env key="VUFIND_URL" value="${vufindurl}" />
      <env key="VUFIND_TEST_THEME" value="${test_theme}" />
      <env key="SOLR_PORT" value="${solr_port}" />
    </exec>
  </target>

  <!-- PHPUnit without logging output, stopping at first error or failure -->
  <target name="phpunitfaster" description="Run tests until first failure">
    <exec dir="${srcdir}/module/VuFind/tests" executable="${sh}" passthru="true" checkreturn="true">
      <arg line="-c &apos;${phpunit_command} --stop-on-defect ${phpunit_extra_params}&apos;" />
      <env key="VUFIND_MINK_DRIVER" value="${mink_driver}" />
      <env key="VUFIND_SCREENSHOT_DIR" value="${screenshot_dir}" />
      <env key="VUFIND_HTML_VALIDATOR" value="${html_validator}" />
      <env key="VUFIND_HTML_VALIDATOR_FAIL_TESTS" value="${html_validator_fail_tests}" />
      <env key="VUFIND_HTML_VALIDATOR_LOG_FILE" value="${html_validator_log_file}" />
      <env key="VUFIND_HTML_VALIDATOR_QUIET" value="${html_validator_quiet}" />
      <env key="VUFIND_SELENIUM_BROWSER" value="${selenium_browser}" />
      <env key="VUFIND_SNOOZE_MULTIPLIER" value="${snooze_multiplier}" />
      <env key="VUFIND_DEFAULT_TEST_TIMEOUT" value="${default_test_timeout}" />
      <env key="VUFIND_LOCAL_DIR" value="${localdir}" />
      <env key="VUFIND_URL" value="${vufindurl}" />
      <env key="VUFIND_TEST_THEME" value="${test_theme}" />
      <env key="SOLR_PORT" value="${solr_port}" />
    </exec>
  </target>

  <target name="installsolr" description="Install Solr">
    <!-- load previously installed version from marker file, if present -->
    <if>
      <available file="${srcdir}/solr/vendor/.installedVersion" />
      <then>
        <loadfile property="existing_solr_version" file="${srcdir}/solr/vendor/.installedVersion" />
      </then>
    </if>
    <!-- only attempt to install Solr if the desired version is not already there,
         and a marker file has not been created to disable Solr installation. -->
    <if>
      <and>
        <not><equals arg1="${existing_solr_version}" arg2="${solr_version}" /></not>
        <not><available file="${srcdir}/solr/.disableAutomaticInstall" /></not>
      </and>
      <then>
        <!-- make sure we don't run out of memory or time during installation: -->
        <php expression="ini_set('memory_limit', '1G');" />
        <php expression="ini_set('default_socket_timeout', '600');" />

        <!-- download from Apache if not already present in the downloads cache -->
        <if>
          <not><available file="${downloadsdir}/solr-${solr_version}.tgz" /></not>
           <then>
            <mkdir dir="${downloadsdir}" />
            <httpget url="https://archive.apache.org/dist/solr/solr/${solr_version}/solr-${solr_version}.tgz" dir="${downloadsdir}" />
          </then>
        </if>
        <!-- unpack the archive into solr/vendor -->
        <mkdir dir="${builddir}/solr" />
        <if>
          <available file="${srcdir}/solr/vendor" type="dir" />
          <then>
            <delete dir="${srcdir}/solr/vendor" includeemptydirs="true" failonerror="false" />
          </then>
        </if>
        <untar file="${downloadsdir}/solr-${solr_version}.tgz" todir="${srcdir}/solr/vendor" removepath="solr-${solr_version}" />
        <!-- make scripts executable -->
        <chmod mode="0755">
          <fileset dir="${srcdir}/solr/vendor/bin">
            <include name="**/**" />
            <exclude name="**/*.cmd" />
          </fileset>
        </chmod>
        <!-- update the marker file with the installed version -->
        <echo file="${srcdir}/solr/vendor/.installedVersion" message="${solr_version}" />
      </then>
    </if>
  </target>

  <target name="installswaggerui">
    <delete dir="${srcdir}/public/swagger-ui" includeemptydirs="true" failonerror="false" />
    <copy todir="${srcdir}/public/swagger-ui">
      <fileset dir="${srcdir}/vendor/swagger-api/swagger-ui/dist" defaultexcludes="false" />
    </copy>
    <reflexive>
      <fileset dir="${srcdir}/public/swagger-ui">
        <include pattern="swagger-initializer.js" />
      </fileset>
      <filterchain>
        <replaceregexp>
          <regexp pattern="url: &quot;.*&quot;" replace="url: &quot;../api/v1?openapi&quot;" />
        </replaceregexp>
      </filterchain>
    </reflexive>
  </target>

  <target name="composer" description="Install dependencies with Composer">
    <property name="composer_filename" value="composer-${composer_version}.phar" />
    <mkdir dir="${downloadsdir}" />
    <if>
      <equals arg1="${composer_version}" arg2="latest-2.x" />
      <then>
        <httpget url="https://getcomposer.org/composer-2.phar" dir="${downloadsdir}" filename="${composer_filename}" />
      </then>
      <else>
        <!-- download if not already present in the downloads cache -->
        <if>
          <not><available file="${downloadsdir}/${composer_filename}" /></not>
           <then>
            <httpget url="https://getcomposer.org/download/${composer_version}/composer.phar" dir="${downloadsdir}" filename="${composer_filename}" />
          </then>
        </if>
      </else>
    </if>
    <echo message="Installing dependencies..." />
    <exec executable="php" passthru="true" checkreturn="true">
      <arg line="${downloadsdir}/${composer_filename} install ${composer_extra_params}" />
    </exec>
  </target>

  <!-- Install and Activate VuFind -->
  <target name="startup" description="install and activate demo">
    <!-- fail if the system is already running -->
    <if>
      <available file="${solr_pid_file}" />
      <then>
        <fail>Solr PID file (${solr_pid_file}) detected. Is the system already running?</fail>
      </then>
    </if>
    <if>
      <available file="${srcdir}/env.bat" />
      <then>
        <fail>Environment file (env.bat) detected. Is the system already running?</fail>
      </then>
    </if>
    <if>
      <available file="${srcdir}/env.sh" />
      <then>
        <fail>Environment file (env.sh) detected. Is the system already running?</fail>
      </then>
    </if>

    <phingcall target="check_local_config" />

    <!-- Install / update dependencies -->
    <phingcall target="composer" />

    <!-- run extra startup action, if any -->
    <if>
      <not>
        <equals arg1="${extra_startup_command}" arg2="" />
      </not>
      <then>
        <echo message="Running extra startup command" />
        <exec executable="${sh}" passthru="true">
          <arg line="-c &apos;${extra_startup_command}&apos;" />
          <env key="VUFIND_HOME" value="${srcdir}" />
          <env key="VUFIND_LOCAL_DIR" value="${localdir}" />
        </exec>
      </then>
    </if>

    <!-- set up appropriate read/write permissions for Apache -->
    <exec executable="chmod">
      <arg line="-R a+w ${localdir}/cache" />
    </exec>
    <exec executable="touch">
      <arg line="${srcdir}/vufind-mail.log" />
    </exec>
    <exec executable="chmod">
      <arg line="a+w ${srcdir}/vufind-mail.log" />
    </exec>
    <exec executable="touch">
      <arg line="${srcdir}/vufind-exception.log" />
    </exec>
    <exec executable="chmod">
      <arg line="a+w ${srcdir}/vufind-exception.log" />
    </exec>

    <phingcall target="configure_install" />

    <!-- Activate Selenium (if a path has been provided) -->
    <if>
      <not>
        <equals arg1="${seleniumjar}" arg2="" />
      </not>
      <then>
        <exec executable="xvfb-run" passthru="true" spawn="true" checkreturn="true">
          <arg line="--server-args=&quot;-screen 0 1024x768x24&quot; java -jar ${seleniumjar}" />
        </exec>
      </then>
    </if>

    <!-- Activate Apache (if an apachectl path has been provided) -->
    <if>
      <not>
        <equals arg1="${apachectl}" arg2="" />
      </not>
      <then>
        <copy file="${localdir}/httpd-vufind.conf" tofile="${apacheconfdir}/vufindtest.conf" />
        <if>
          <istrue value="${phpunit_remote_coverage}" />
          <then>
            <reflexive file="${apacheconfdir}/vufindtest.conf">
              <filterchain>
                <replaceregexp>
                  <regexp pattern="#SetEnv VUFIND_CODE_COVERAGE 1" replace="SetEnv VUFIND_CODE_COVERAGE 1" />
                </replaceregexp>
              </filterchain>
            </reflexive>
          </then>
        </if>
        <exec executable="${sh}" passthru="true">
          <arg line="-c &apos;${apachectl} restart&apos;" />
        </exec>
      </then>
    </if>

    <!-- build and configure the requested database type -->
    <phingcall target="setup_database" />

    <!-- start Solr -->
    <phingcall target="setup_solr" />

    <phingcall target="import_biblios" />
    <phingcall target="import_authorities" />
    <phingcall target="delete_fake_records" />
    <phingcall target="build_alphabrowse" />
  </target>

  <!-- A helper task to check for existing configuration -->
  <target name="check_local_config" description="check for local configuration and fail if it exists">
    <!-- fail if a local config.ini already exists -->
    <property name="local_config_ini" value="${localdir}/config/vufind/config.ini" />
    <if>
      <available file="${local_config_ini}" />
      <then>
        <fail>${local_config_ini} already exists</fail>
      </then>
    </if>
  </target>

  <!-- Setup basic configuration and run the install command -->
  <target name="configure_install" description="configure and run installation">
    <phingcall target="check_local_config" />

    <!-- Generate basic configuration -->
    <php expression="substr(parse_url('${vufindurl}', PHP_URL_PATH), 1)" returnProperty="basepath" />
    <exec executable="php" passthru="true" checkreturn="true">
      <arg line="${srcdir}/install.php --basepath=/${basepath} --non-interactive --solr-port=${solr_port}" />
    </exec>

    <!-- Update config.ini to activate DB connection, exception logging and test mode -->
    <if>
      <equals arg1="${dbtype}" arg2="pgsql" />
      <then>
        <property name="db_connection_string" value="pgsql://${vufinddbuser}:${vufinddbpass}@${pgsqlhost}/${vufinddb}" />
      </then>
      <else>
        <property name="db_connection_string" value="mysql://${vufinddbuser}:${vufinddbpass}@${mysqlhost}:${mysqlport}/${vufinddb}" />
      </else>
    </if>

    <copy file="${srcdir}/config/vufind/config.ini" tofile="${localdir}/config/vufind/config.ini">
      <filterchain>
        <replaceregexp>
          <regexp pattern="mysql://root@localhost/vufind" replace="${db_connection_string}" />
          <regexp pattern=";file\s+= /var/log/vufind.log:alert,error,notice,debug" replace="file = ${srcdir}/vufind-exception.log:alert-5,error-5" />
          <regexp pattern="(\[System\]\s+)" replace="\1runningTestSuite=1" />
          <regexp pattern="(url\s+= http://localhost):8983/solr" replace="\1:${solr_port}/solr" />
        </replaceregexp>
      </filterchain>
    </copy>

    <copy file="${srcdir}/config/vufind/Search2.ini" tofile="${localdir}/config/vufind/Search2.ini">
      <filterchain>
        <replaceregexp>
          <regexp pattern="(url\s+= http://localhost):8983/solr" replace="\1:${solr_port}/solr" />
        </replaceregexp>
      </filterchain>
    </copy>

    <if>
      <not><istrue value="${disable_csp}" /></not>
      <then>
        <!-- Update contentsecuritypolicy.ini to enforce the CSP. -->
        <copy file="${srcdir}/config/vufind/contentsecuritypolicy.ini" tofile="${localdir}/config/vufind/contentsecuritypolicy.ini">
          <filterchain>
            <replaceregexp>
              <regexp pattern="(enabled\[.+\]) = .*" replace="\1 = true" />
            </replaceregexp>
          </filterchain>
        </copy>
      </then>
    </if>

    <!-- Add local translations for tests -->
    <if>
      <not>
        <available file="${localdir}/languages" type="dir" />
      </not>
      <then>
        <mkdir dir="${localdir}/languages" />
      </then>
    </if>
    <if>
      <not>
        <available file="${localdir}/languages/Facets" type="dir" />
      </not>
      <then>
        <mkdir dir="${localdir}/languages/Facets" />
      </then>
    </if>
    <append destFile="${localdir}/languages/en.ini" text="location_main = Main Library${line.separator}" />
    <append destFile="${localdir}/languages/Facets/en.ini" text="0/level1a/ = Top Level, Sorted Last${line.separator}" />
    <append destFile="${localdir}/languages/Facets/en.ini" text="0/level1z/ = Top Level, Sorted First${line.separator}" />
    <append destFile="${localdir}/languages/Facets/en.ini" text="1/level1z/level2y/ = Second Level, Sorted Last${line.separator}" />
    <append destFile="${localdir}/languages/Facets/en.ini" text="1/level1z/level2z/ = Second Level, Sorted First${line.separator}" />

    <!-- Add templates to a minktest theme for tests -->
    <property name="themedir" value="${srcdir}/themes/minktest" />
    <property name="contentdir" value="${themedir}/templates/content" />
    <if>
      <not>
        <available file="${contentdir}/test/sub" type="dir" />
      </not>
      <then>
        <!-- avoid PHP Errors by creating each level separately -->
        <mkdir dir="${themedir}" />
        <mkdir dir="${themedir}/templates" />
        <mkdir dir="${contentdir}" />
        <mkdir dir="${contentdir}/test" />
        <mkdir dir="${contentdir}/test/sub" />
      </then>
    </if>
    <echo file="${themedir}/theme.config.php">&lt;?php
return [
    'extends' =&gt; 'sandal',
];
</echo>
    <echo file="${contentdir}/content.phtml">&lt;?php include $this-&gt;parentTemplate('content/content.phtml');?&gt;

&lt;div class="content-footer"&gt;Content page footer&lt;/div&gt;
</echo>
    <echo file="${contentdir}/test.phtml">&lt;h1&gt;MAIN LEVEL TEST&lt;/h1&gt;</echo>
    <echo file="${contentdir}/test.phtml">&lt;h1&gt;MAIN LEVEL TEST&lt;/h1&gt;</echo>
    <echo file="${contentdir}/test_fi.phtml">&lt;h1&gt;FINNISH TEST&lt;/h1&gt;</echo>
    <echo file="${contentdir}/test/test.phtml">&lt;h1&gt;SUB LEVEL PHTML&lt;/h1&gt;</echo>
    <echo file="${contentdir}/test/testmd.md"># SUB LEVEL MD</echo>
    <echo file="${contentdir}/test/sub/test.phtml">&lt;h1&gt;SUB SUB LEVEL PHTML&lt;/h1&gt;</echo>
  </target>

  <target name="setup_database" description="setup demo database">
    <if>
      <equals arg1="${dbtype}" arg2="pgsql" />
      <then>
        <!-- build database -->
        <if>
          <equals arg1="${psql_needs_sudo}" arg2="false" />
          <then>
            <exec executable="psql">
              <arg line="-c &quot;DROP DATABASE ${vufinddb};&quot; ${pgsqlrootuser}" />
            </exec>
            <exec executable="psql">
              <arg line="-c &quot;DROP USER ${vufinddbuser};&quot; ${pgsqlrootuser}" />
            </exec>
            <exec executable="psql" checkreturn="true">
              <arg line="-c &quot;CREATE DATABASE ${vufinddb};&quot; ${pgsqlrootuser}" />
            </exec>
            <exec executable="psql" checkreturn="true">
              <arg line="-c &quot;CREATE USER ${vufinddbuser} PASSWORD '${vufinddbpass}';&quot; ${pgsqlrootuser}" />
            </exec>
            <exec executable="psql" checkreturn="true">
              <arg line="-c &quot;GRANT ALL ON DATABASE ${vufinddb} TO ${vufinddbuser};&quot; ${pgsqlrootuser}" />
            </exec>
          </then>
          <else>
            <exec executable="sudo">
              <arg line="su -c &quot;psql -c \&quot;DROP DATABASE ${vufinddb};\&quot;&quot; ${pgsqlrootuser}" />
            </exec>
            <exec executable="sudo">
              <arg line="su -c &quot;psql -c \&quot;DROP USER ${vufinddbuser};\&quot;&quot; ${pgsqlrootuser}" />
            </exec>
            <exec executable="sudo" checkreturn="true">
              <arg line="su -c &quot;psql -c \&quot;CREATE DATABASE ${vufinddb};\&quot;&quot; ${pgsqlrootuser}" />
            </exec>
            <exec executable="sudo" checkreturn="true">
              <arg line="su -c &quot;psql -c \&quot;CREATE USER ${vufinddbuser} PASSWORD '${vufinddbpass}';\&quot;&quot; ${pgsqlrootuser}" />
            </exec>
            <exec executable="sudo" checkreturn="true">
              <arg line="su -c &quot;psql -c \&quot;GRANT ALL ON DATABASE ${vufinddb} TO ${vufinddbuser};\&quot;&quot; ${pgsqlrootuser}" />
            </exec>
          </else>
        </if>

        <exec executable="psql" checkreturn="true">
          <arg line="-U ${vufinddbuser} -f ${srcdir}/module/VuFind/sql/pgsql.sql ${vufinddb}" />
          <env key="PGPASSWORD" value="${vufinddbpass}" />
        </exec>
      </then>
      <else>
        <!-- build database -->
        <exec executable="mysql" passthru="true">
          <arg line="${mysqlconnectionargs} -e &quot;DROP DATABASE IF EXISTS ${vufinddb}&quot;" />
        </exec>
        <exec executable="mysql" checkreturn="true" passthru="true">
          <arg line="${mysqlconnectionargs} -e &quot;CREATE DATABASE ${vufinddb}&quot;" />
        </exec>
        <exec executable="mysql" passthru="true">
          <arg line="${mysqlconnectionargs} -e &quot;DROP USER IF EXISTS '${vufinddbuser}'@'%'&quot;" />
        </exec>
        <exec executable="mysql" checkreturn="true" passthru="true">
          <arg line="${mysqlconnectionargs} -e &quot;CREATE USER '${vufinddbuser}'@'%' IDENTIFIED BY '${vufinddbpass}'&quot;" />
        </exec>
        <exec executable="mysql" checkreturn="true" passthru="true">
          <arg line="${mysqlconnectionargs} -e &quot;GRANT SELECT,INSERT,UPDATE,DELETE ON ${vufinddb}.* TO '${vufinddbuser}'@'%' WITH GRANT OPTION&quot;" />
        </exec>
        <exec executable="mysql" checkreturn="true" passthru="true">
          <arg line="${mysqlconnectionargs} -e &quot;FLUSH PRIVILEGES&quot;" />
        </exec>
        <exec executable="mysql" checkreturn="true" passthru="true">
          <arg line="${mysqlconnectionargs} -D ${vufinddb} &lt; ${srcdir}/module/VuFind/sql/mysql.sql" />
        </exec>
      </else>
    </if>
  </target>

  <!-- Set up Solr -->
  <target name="setup_solr">
    <!-- Start Solr using restart in case of old PID files -->
    <exec executable="${srcdir}/solr.sh" passthru="true" checkreturn="true">
      <arg line="restart" />
      <env key="SOLR_PID_DIR" value="${localdir}" />
      <env key="VUFIND_HOME" value="${srcdir}" />
      <env key="SOLR_ADDITIONAL_JVM_OPTIONS" value="${solr_additional_jvm_options}" />
      <env key="SOLR_PORT" value="${solr_port}" />
    </exec>
    <!-- fail if Solr did not start up successfully: -->
    <if>
      <not><available file="${solr_pid_file}" /></not>
      <then>
        <fail>Solr PID file (${solr_pid_file}) not detected. Solr startup failed.</fail>
      </then>
    </if>

    <if>
      <equals arg1="0" arg2="${solr_startup_sleep}" />
      <then>
        <!-- do nothing -->
      </then>
      <else>
        <echo message="Waiting ${solr_startup_sleep} seconds for Solr to be ready..." />
        <exec executable="sleep">
          <arg line="${solr_startup_sleep}" />
        </exec>
      </else>
    </if>
  </target>

  <!-- Import test biblio data -->
  <target name="import_biblios" description="import all biblio test records">
    <foreach param="relfilename" absparam="filename" target="importrec">
      <fileset dir="${srcdir}/tests/data">
          <include name="*.mrc" />
          <include name="*.xml" />
      </fileset>
    </foreach>
  </target>

  <!-- Import test authority data -->
  <target name="import_authorities" description="import all authority test records">
    <foreach param="relfilename" absparam="filename" target="importauthrec">
      <fileset dir="${srcdir}/tests/data/authority">
          <include name="*.mrc" />
      </fileset>
    </foreach>
  </target>

  <!-- Delete some fake record IDs so we have deleted records to test with -->
  <target name="delete_fake_records" description="delete fake records">
    <exec executable="php" checkreturn="true" passthru="true">
      <arg line="${srcdir}/public/index.php util/deletes ${srcdir}/tests/data/fake-deleted-ids.txt flat" />
      <env key="VUFIND_HOME" value="${srcdir}" />
      <env key="VUFIND_LOCAL_DIR" value="${localdir}" />
    </exec>
  </target>

  <!-- Build alphabrowse index -->
  <target name="build_alphabrowse" description="build the alphabrowse index">
    <exec executable="${srcdir}/index-alphabetic-browse.sh" passthru="true">
      <env key="VUFIND_HOME" value="${srcdir}" />
      <env key="VUFIND_LOCAL_DIR" value="${localdir}" />
    </exec>
  </target>

  <!-- Uninstall and Deactivate VuFind -->
  <target name="shutdown" description="deactivate and uninstall demo">

    <exec executable="git" outputProperty="git_status">
      <arg line="status --porcelain --untracked-files=no" />
    </exec>
    <if>
      <not>
        <equals arg1="${git_status}" arg2="" />
      </not>
      <then>
        <fail>
          Changes detected in tracked files:
${git_status}
        </fail>
      </then>
    </if>

    <!-- Remove Apache settings (if Apache was enabled) -->
    <if>
      <and>
        <not>
          <equals arg1="${apachectl}" arg2="" />
        </not>
        <available file="${apacheconfdir}/vufindtest.conf" />
      </and>
      <then>
        <delete file="${apacheconfdir}/vufindtest.conf" />
        <exec executable="${sh}" passthru="true">
          <arg line="-c &apos;${apachectl} restart&apos;" />
        </exec>
      </then>
    </if>

    <!-- drop database -->
    <if>
      <equals arg1="${dbtype}" arg2="pgsql" />
      <then>
        <exec executable="sudo" checkreturn="true">
          <arg line="su -c &quot;psql -c \&quot;DROP DATABASE ${vufinddb};\&quot;&quot; ${pgsqlrootuser}" />
        </exec>
        <exec executable="sudo" checkreturn="true">
          <arg line="su -c &quot;psql -c \&quot;DROP USER ${vufinddbuser};\&quot;&quot; ${pgsqlrootuser}" />
        </exec>
      </then>
      <else>
        <exec executable="mysql">
          <arg line="${mysqlconnectionargs} -e &quot;DROP USER IF EXISTS '${vufinddbuser}'@'%'&quot;" />
        </exec>
        <exec executable="mysql">
          <arg line="${mysqlconnectionargs} -e &quot;DROP DATABASE IF EXISTS ${vufinddb}&quot;" />
        </exec>
      </else>
    </if>

    <!-- stop Solr -->
    <if>
      <available file="${solr_pid_file}" />
      <then>
        <exec executable="${srcdir}/solr.sh" passthru="true">
          <arg line="stop" />
          <env key="SOLR_PID_DIR" value="${localdir}" />
          <env key="VUFIND_HOME" value="${srcdir}" />
          <env key="SOLR_ADDITIONAL_JVM_OPTIONS" value="${solr_additional_jvm_options}" />
          <env key="SOLR_PORT" value="${solr_port}" />
        </exec>
      </then>
    </if>

    <!-- run extra cleanup action, if any -->
    <if>
      <not>
        <equals arg1="${extra_shutdown_cleanup}" arg2="" />
      </not>
      <then>
        <echo message="Running extra shutdown cleanup" />
        <exec executable="${sh}" passthru="true">
          <arg line="-c &apos;${extra_shutdown_cleanup}&apos;" />
          <env key="VUFIND_HOME" value="${srcdir}" />
          <env key="VUFIND_LOCAL_DIR" value="${localdir}" />
        </exec>
      </then>
    </if>

    <!-- shut down selenium if necessary -->
    <if>
      <not>
        <equals arg1="${seleniumjar}" arg2="" />
      </not>
      <then>
        <exec executable="pkill">
          <arg line="-f xvfb" />
        </exec>
        <basename file="${seleniumjar}" property="seleniumbase" />
        <exec executable="pkill">
          <arg line="-f &quot;java -jar ${seleniumbase}&quot;" />
        </exec>
      </then>
    </if>

    <!-- delete the configuration, sample index, logs and cache data -->
    <if>
      <available file="${srcdir}/env.bat" />
      <then>
        <delete file="${srcdir}/env.bat" failonerror="true" />
      </then>
    </if>
    <if>
      <available file="${srcdir}/env.sh" />
      <then>
        <delete file="${srcdir}/env.sh" failonerror="true" />
      </then>
    </if>
    <if>
      <available file="${srcdir}/import/solrmarc.log" />
      <then>
        <delete file="${srcdir}/import/solrmarc.log" failonerror="true" />
      </then>
    </if>
    <if>
      <available file="${srcdir}/solr" type="dir" />
      <then>
        <delete dir="${srcdir}/solr" includeemptydirs="true" failonerror="true" />
      </then>
    </if>
    <!-- Remove any composer.phar installed by an older build script version: -->
    <if>
      <available file="${srcdir}/composer.phar" />
      <then>
        <delete file="${srcdir}/composer.phar" failonerror="true" />
      </then>
    </if>
    <if>
      <available file="${srcdir}/vufind-exception.log" />
      <then>
        <filesize file="${srcdir}/vufind-exception.log" propertyname="exception.log.size" />
        <if>
          <not><equals arg1="${exception.log.size}" arg2="0" /></not>
          <then>
            <loadfile property="exception.log.contents" file="${srcdir}/vufind-exception.log" />
            <echo message="Exception log not empty; contents: ${exception.log.contents}" />
          </then>
        </if>
        <delete file="${srcdir}/vufind-exception.log" failonerror="true" />
      </then>
    </if>
    <if>
      <available file="${srcdir}/vufind-mail.log" />
      <then>
        <delete file="${srcdir}/vufind-mail.log" failonerror="true" />
      </then>
    </if>
    <if>
      <available file="${localdir}" type="dir" />
      <then>
        <delete dir="${localdir}" includeemptydirs="true" failonerror="true" />
      </then>
    </if>
    <exec executable="git" passthru="true">
      <arg line="reset --hard" />
    </exec>
  </target>

  <!-- Reset database and configuration of the demo setup -->
  <target name="reset_setup" description="reset configuration and database of demo">
    <property name="solr_pid_file" value="${localdir}/solr-${solr_port}.pid" />
    <!-- fail if the system is not already running -->
    <if>
      <not><available file="${solr_pid_file}" /></not>
      <then>
        <fail>Solr PID file (${solr_pid_file}) not detected. Is the demo system not running?</fail>
      </then>
    </if>

    <delete>
      <fileset dir="${localdir}/config/vufind">
        <patternset>
          <include name="*.ini" />
          <include name="*.ini.bak" />
          <include name="*.json" />
          <include name="*.json.bak" />
          <include name="*.key" />
          <include name="*.key.bak" />
          <include name="*.yaml" />
          <include name="*.yaml.bak" />
        </patternset>
      </fileset>
    </delete>
    <delete>
      <fileset dir="${localdir}/cache">
        <include name="**/*" />
      </fileset>
    </delete>
    <delete>
      <fileset dir="${localdir}/languages">
        <include name="**/*" />
      </fileset>
    </delete>
    <delete dir="${srcdir}/themes/minktest" />
    <delete file="${srcdir}/env.bat" />
    <delete file="${srcdir}/env.sh" />
    <delete file="${localdir}/import/import.properties" />
    <delete file="${localdir}/import/import_auth.properties" />

    <phingcall target="configure_install" />
    <phingcall target="setup_database" />
    <phingcall target="delete_fake_records" />
  </target>

  <!-- Prepare VuFind for distribution -->
  <target name="package" description="build VuFind packages for distribution">
    <!-- make sure the work area is empty, then rebuild it -->
    <delete dir="${builddir}/packages" includeemptydirs="true" failonerror="false" />
    <mkdir dir="${builddir}/packages" />
    <delete dir="${builddir}/export" includeemptydirs="true" failonerror="false" />
    <mkdir dir="${builddir}/export/vufind/usr/local/vufind" />

    <!-- load the relevant files into the work area -->
    <phingcall target="composer">
      <property name="composer_extra_params" value="--no-dev" />
    </phingcall>
    <exec executable="git">
      <arg line="archive HEAD --format=tar | tar -x -C ${builddir}/export/vufind/usr/local/vufind" />
    </exec>
    <copy todir="${builddir}/export/vufind/usr/local/vufind/vendor">
      <fileset dir="${srcdir}/vendor" defaultexcludes="false" />
    </copy>
    <copy todir="${builddir}/export/vufind/usr/local/vufind/solr/vendor">
      <fileset dir="${srcdir}/solr/vendor" defaultexcludes="false" />
    </copy>
    <copy todir="${builddir}/export/vufind/usr/local/vufind/public/swagger-ui">
      <fileset dir="${srcdir}/public/swagger-ui" defaultexcludes="false" />
    </copy>

    <!-- create a version-specific symlink so that tar/zip packages will have
         appropriate directory structures. -->
    <exec executable="ln">
      <arg line="-s ${builddir}/export/vufind/usr/local/vufind ${builddir}/export/vufind-${version}" />
    </exec>

    <!-- build the standard tar.gz archive -->
    <echo message="Building .tar.gz...." />
    <exec dir="${builddir}/export" executable="tar" checkreturn="true">
      <arg line="czfh ${builddir}/packages/vufind-${version}.tar.gz vufind-${version}" />
    </exec>

    <!-- build the a zip archive -->
    <echo message="Building .zip...." />
    <exec dir="${builddir}/export" executable="zip" checkreturn="true">
      <arg line="-r ${builddir}/packages/vufind-${version}.zip vufind-${version}" />
    </exec>

    <!-- build the DEB package -->
    <echo message="Building .deb...." />
    <move file="${builddir}/export/vufind/usr/local/vufind/packages/DEBIAN" todir="${builddir}/export/vufind" includeemptydirs="true"/>
    <exec executable="chmod">
      <arg line="0775 ${builddir}/export/vufind/DEBIAN/postinst" />
    </exec>
    <exec executable="dpkg-deb" checkreturn="true">
      <arg line="-b ${builddir}/export/vufind ${builddir}/packages/vufind_${version}.deb" />
    </exec>

    <!-- clean up -->
    <delete dir="${builddir}/export" includeemptydirs="true" failonerror="true" />

    <!-- report success -->
    <echo message="Packages successfully generated in ${builddir}/packages" />
  </target>

  <target name="importauthrec" description="import each of the MARC authority test records">
    <!-- perform the import -->
    <exec executable="${srcdir}/import-marc-auth.sh" passthru="true" checkreturn="true">
      <arg line="${filename} marc_auth_ils.properties" />
      <env key="VUFIND_HOME" value="${srcdir}" />
      <env key="VUFIND_LOCAL_DIR" value="${localdir}" />
    </exec>
  </target>

  <target name="importrec" description="import each of the MARC bibliographic test records">
    <basename file="${filename}" property="BASENAME" />

    <!-- create custom import configurations to load the MARC filename into the building facet to help
          test cases to limit searches to within specific collections of test records.
          Note: ${localdir}/import/import.properties is created in install.php. -->
    <copy file="${srcdir}/import/marc_local.properties" tofile="${localdir}/import/marc-${BASENAME}.properties" overwrite="true" />
    <append destFile="${localdir}/import/marc-${BASENAME}.properties" text="building=&quot;${BASENAME}&quot;${line.separator}" />

    <copy file="${localdir}/import/import.properties" tofile="${localdir}/import/import-${BASENAME}.properties" />
    <!-- normalize Unicode to avoid HTML validation warnings -->
    <append destFile="${localdir}/import/import-${BASENAME}.properties" text="marc.unicode_normalize = C${line.separator}" />
    <reflexive>
      <fileset dir="${localdir}/import">
        <include pattern="import-${BASENAME}.properties" />
      </fileset>
      <filterchain>
        <replaceregexp>
          <regexp pattern="marc_local.properties" replace="marc-${BASENAME}.properties" />
        </replaceregexp>
      </filterchain>
    </reflexive>

    <!-- if there is a file-specific import configuration, load it now: -->
    <if>
      <available file="${filename}.properties" />
      <then>
        <echo message="Found custom import configs for ${filename}." />
        <append file="${filename}.properties" destFile="${localdir}/import/marc-${BASENAME}.properties" />
      </then>
    </if>

    <!-- perform the import -->
    <exec executable="${srcdir}/import-marc.sh" passthru="true" checkreturn="true">
      <arg line="-p ${localdir}/import/import-${BASENAME}.properties ${filename}" />
      <env key="VUFIND_HOME" value="${srcdir}" />
      <env key="VUFIND_LOCAL_DIR" value="${localdir}" />
    </exec>

    <!-- clean up temp files -->
    <delete file="${localdir}/import/marc-${BASENAME}.properties" />
    <delete file="${localdir}/import/import-${BASENAME}.properties" />
  </target>

  <target name="patch-dependencies" description="apply fixes to dependencies">
    <!-- Fix for PHP 8 incompatibility in chrome-mink-driver 2.8.0: -->
    <reflexive>
      <fileset dir="vendor/dmore/chrome-mink-driver/src">
        <include pattern="ChromeDriver.php" />
      </fileset>
      <filterchain>
        <replaceregexp>
          <regexp pattern="\$base_url," replace="\$base_url = &apos;&apos;," />
        </replaceregexp>
      </filterchain>
    </reflexive>
  </target>

  <!-- Update bootstrap3 templates from bootstrap5 -->
  <!-- N.B. This destroys any existing bootstrap3 templates (except explicitly excluded ones) -->
  <target name="update-bootstrap3">
    <property name="templatesdir" value="${srcdir}/themes/bootstrap3/templates" />
    <if>
      <available file="${templatesdir}"></available>
      <then>
        <echo message="Checking for uncommitted changes in ${templatesdir}" />
        <exec executable="git" checkreturn="true" passthru="true">
          <arg line="diff --exit-code ${templatesdir}" />
        </exec>
        <delete failonerror="true">
          <fileset dir="${templatesdir}">
            <exclude name="header.phtml" />
            <exclude name="RecordTab/similaritemscarousel.phtml" />
          </fileset>
        </delete>
      </then>
    </if>
    <mkdir dir="${templatesdir}"></mkdir>
    <copy todir="${templatesdir}">
      <fileset dir="${srcdir}/themes/bootstrap5/templates">
        <exclude name="header.phtml" />
        <exclude name="RecordTab/similaritemscarousel.phtml" />
      </fileset>
    </copy>
    <reflexive>
      <fileset dir="${templatesdir}">
        <include pattern="**/*.phtml" />
        <exclude name="header.phtml" />
        <exclude name="RecordTab/similaritemscarousel.phtml" />
      </fileset>
      <filterchain>
        <replaceregexp>
          <!-- HTML attributes -->
          <regexp pattern=" data-bs-(dismiss|ride|slide|slide-to|target|toggle)=" replace=" data-\1=" />

          <!-- HTMLAttributes helper -->
          <regexp pattern="'data-bs-(dismiss|target|toggle)'" replace="'data-\1'" />
        </replaceregexp>
      </filterchain>
    </reflexive>
  </target>

  <!-- Update bootstrap5 templates from bootstrap3 -->
  <!-- N.B. This destroys any existing bootstrap5 templates (except explicitly excluded ones) -->
  <target name="update-bootstrap5">
    <property name="templatesdir" value="${srcdir}/themes/bootstrap5/templates" />
    <if>
      <available file="${templatesdir}"></available>
      <then>
        <echo message="Checking for uncommitted changes in ${templatesdir}" />
        <exec executable="git" checkreturn="true" passthru="true">
          <arg line="diff --exit-code ${templatesdir}" />
        </exec>
        <delete failonerror="true">
          <fileset dir="${templatesdir}">
            <exclude name="header.phtml" />
            <exclude name="RecordTab/similaritemscarousel.phtml" />
          </fileset>
        </delete>
      </then>
    </if>
    <mkdir dir="${templatesdir}"></mkdir>
    <copy todir="${templatesdir}">
      <fileset dir="${srcdir}/themes/bootstrap3/templates">
        <exclude name="header.phtml" />
        <exclude name="RecordTab/similaritemscarousel.phtml" />
      </fileset>
    </copy>
    <reflexive>
      <fileset dir="${templatesdir}">
        <include pattern="**/*.phtml" />
      </fileset>
      <filterchain>
        <replaceregexp>
          <!-- HTML attributes -->
          <regexp pattern=" data-(dismiss|ride|slide|slide-to|target|toggle)=(?!&quot;vufind)" replace=" data-bs-\1=" />

          <!-- HTMLAttributes helper -->
          <regexp pattern="'data-(dismiss|target|toggle)'" replace="'data-bs-\1'" />
        </replaceregexp>
      </filterchain>
    </reflexive>
  </target>

  <!-- Check that bootstrap5 is up to date with bootstrap3 -->
  <target name="check-bootstrap5">
    <property override="true" name="check_dir_base" value="${srcdir}/themes/bootstrap3/templates" />
    <property override="true" name="check_dir_compare" value="${srcdir}/themes/bootstrap5/templates" />
    <foreach target="check-dir-single-file" param="filename" inheritall="true">
      <fileset dir="${check_dir_base}">
        <type type="file" />
        <exclude name="header.phtml" />
        <exclude name="RecordTab/similaritemscarousel.phtml" />
        <different targetdir="${check_dir_compare}" ignoreFileTimes="true" />
      </fileset>
    </foreach>

    <property override="true" name="check_dir_base" value="${srcdir}/themes/bootstrap3/scss" />
    <property override="true" name="check_dir_compare" value="${srcdir}/themes/bootstrap5/scss" />
    <foreach target="check-dir-single-file" param="filename" inheritall="true">
      <fileset dir="${check_dir_base}">
        <type type="file" />
        <exclude name="bootstrap.scss" />
        <exclude name="components/similar-carousel.scss" />
        <exclude name="vendor/**" />
        <different targetdir="${check_dir_compare}" ignoreFileTimes="true" />
      </fileset>
    </foreach>

    <property override="true" name="check_dir_base" value="${srcdir}/themes/bootstrap3/js" />
    <property override="true" name="check_dir_compare" value="${srcdir}/themes/bootstrap5/js" />
    <foreach target="check-dir-single-file" param="filename" inheritall="true">
      <fileset dir="${check_dir_base}">
        <type type="file" />
        <exclude name="account_ajax.js" />
        <exclude name="cart.js" />
        <exclude name="channels.js" />
        <exclude name="lightbox.js" />
        <exclude name="vendor" />
        <exclude name="vendor/bootstrap-accessibility.min.js" />
        <exclude name="vendor/bootstrap.min.js" />
        <different targetdir="${check_dir_compare}" ignoreFileTimes="true" />
      </fileset>
    </foreach>
  </target>
  <!-- subtask for check-bootstrap5 -->
  <target name="check-dir-single-file">
    <loadFile property="base_file" file="${check_dir_base}/${filename}">
      <filterchain>
        <replaceregexp>
          <!-- HTML attributes -->
          <regexp pattern=" data-(dismiss|ride|slide|slide-to|target|toggle)=(?!&quot;vufind)" replace=" data-bs-\1=" />

          <!-- HTMLAttributes helper -->
          <regexp pattern="'data-(dismiss|target|toggle)'" replace="'data-bs-\1'" />

          <!-- button-size mixin -->
          <regexp pattern="@include button-size\((.+),(.+),(.+),(.+),(.+)\)" replace="@include button-size(\1,\2,\3,\5)" />
        </replaceregexp>
      </filterchain>
    </loadFile>
    <loadFile property="compare_file" file="${check_dir_compare}/${filename}" />
    <if>
      <not>
        <equals arg1="${base_file}" arg2="${compare_file}" />
      </not>
      <then>
        <fail message="${check_dir_base}/${filename} and ${check_dir_compare}/${filename} are out of sync" />
      </then>
    </if>
  </target>

</project>
