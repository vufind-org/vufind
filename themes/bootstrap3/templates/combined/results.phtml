<?
  // Set up page title:
  $lookfor = $this->params->getDisplayQuery();
  if (isset($this->overrideTitle)) {
    $this->headTitle($this->overrideTitle);
  } else {
      $this->headTitle($this->translate('Search Results') . (empty($lookfor) ? '' : " - {$lookfor}"));
  }

  // Set up search box:
  $this->layout()->searchbox = $this->context($this)->renderInContext(
    'search/searchbox.phtml',
    array(
      'lookfor' => $lookfor,
      'searchIndex' => $this->params->getSearchHandler(),
      'searchType' => $this->params->getSearchType(),
      'searchId' => $this->results->getSearchId(),
      'searchClassId' => $this->params->getsearchClassId(),
      'checkboxFilters' => $this->params->getCheckboxFacets(),
      'filterList' => $this->params->getFilters(),
      'hasDefaultsApplied' => $this->params->hasDefaultsApplied(),
      'selectedShards' => $this->params->getSelectedShards()
    )
  );

  // Create shortcut to combined results (since $this->results may get overwritten in processing below):
  $combinedResults = $this->results;

  // Set up breadcrumbs:
  if (isset($this->overrideTitle)) {
    $this->layout()->breadcrumbs = '<li class="active">' . $this->escapeHtml($this->overrideTitle) . '</li>';
  } else {
    $this->layout()->breadcrumbs = '<li class="active">' . $this->transEsc('Combined Search') . ': ' .
      $this->escapeHtml($lookfor) . '</li>';
  }

  // Load Javascript dependencies into header:
  $this->headScript()->appendFile("check_item_statuses.js");
  $this->headScript()->appendFile("check_save_statuses.js");
  // Style
  $this->headLink()->appendStylesheet('combined-search.css');
?>
<?=$this->flashmessages()?>
<form class="form-inline" method="post" name="bulkActionForm" action="<?=$this->url('cart-home')?>">
  <? $recs = $combinedResults->getRecommendations('top'); if (!empty($recs)): ?>
    <div>
      <? foreach ($recs as $current): ?>
        <?=$this->recommend($current)?>
      <? endforeach; ?>
    </div>
  <? endif; ?>
  <? if ($this->supportsCart && $this->cart()->isActive()): ?>
    <?=$this->context($this)->renderInContext('search/bulk-action-buttons.phtml', array('idPrefix' => ''))?>
  <? endif; ?>
  <div class="row">
    <? $columnIndex = 0; ?>
    <? $span = floor(12/$columns); ?>
    <? $sectionCount = count($this->combinedResults); ?>
    <? foreach ($this->combinedResults as $searchClassId => $currentSearch): ?>
      <? if ((!isset($currentSearch['ajax']) || !$currentSearch['ajax']) && isset($currentSearch['hide_if_empty']) && $currentSearch['hide_if_empty'] && $currentSearch['view']->results->getResultTotal() == 0) { continue; } ?>
      <? if ($this->placement == 'distributed' || $columnIndex < $columns): ?>
        <div class="col-sm-<?=$span ?><? if('left' == $this->placement): if($columnIndex == $columns-1): ?> col-sm-pull-<?=$span*($columns-1) ?><? else: ?> col-sm-push-<?=$span ?><? endif; ?><? endif; ?> combined-list">
      <? endif; ?>
        <div id="combined_<?=$this->escapeHtml($searchClassId)?>">
          <? $templateSuffix = (isset($currentSearch['ajax']) && $currentSearch['ajax']) ? 'ajax' : 'list'; ?>
          <?=$this->render('combined/results-' . $templateSuffix . '.phtml', array('searchClassId' => $searchClassId, 'currentSearch' => $currentSearch))?>
        </div>
      <? ++$columnIndex ?>
      <? if($this->placement == 'distributed' || $columnIndex < $columns || $columnIndex == $sectionCount): ?>
        </div>
      <? endif; ?>
    <? endforeach; ?>
  </div>
  <? $recs = $combinedResults->getRecommendations('bottom'); if (!empty($recs)): ?>
    <div>
      <? foreach ($recs as $current): ?>
        <?=$this->recommend($current)?>
      <? endforeach; ?>
    </div>
  <? endif; ?>
</form>