<?php if (empty($this->cluster['list'])): ?>
  <div class="facet"><?=$this->transEsc('facet_list_empty')?></div>
  <?php return; // We're done if the list is empty! ?>
<?php endif; ?>

<?php
  $truncateSettings = [
    'rows' => $this->facets_before_more,
    'btn-class' => 'facet',
    'more-label' => $this->transEsc('more') . ' ...',
    'less-label' => $this->transEsc('less') . ' ...',
    'wrapper-class' => false,
    'wrapper-tagname' => 'div',
  ];
?>
<div class="truncate-facets" data-truncate="<?=$this->escapeHtml(json_encode($truncateSettings))?>">
  <?php foreach ($this->cluster['list'] as $i => $thisFacet): ?>
    <?php if ($i == $this->facets_before_more): ?>
      <?php if ($facetLightbox = $this->options->getFacetListAction()): ?>
        <?php $moreUrl = $this->url($facetLightbox) . $results->getUrlQuery()->getParams() . '&amp;facet=' . $this->title . '&amp;facetop=' . $thisFacet['operator'] . '&amp;facetexclude=' . ($this->allowExclude ? 1 : 0); ?>
      <?php else: ?>
        <?php $moreUrl = '#'; ?>
      <?php endif; ?>
      <?php if (($this->showMoreInLightbox && $this->showMoreInLightbox !== 'more') && $facetLightbox): ?>
        <a class="facet narrow-toggle more-facets" data-lightbox href="<?=$moreUrl ?>" rel="nofollow">
          <span class="text"><?=$this->transEsc('more')?> ...</span>
        </a>
        <?php break; ?>
      <?php endif; ?>
    <?php endif; ?>
    <?=$this->render('Recommend/SideFacets/single-facet.phtml', [
      'exclude' => $this->allowExclude,
      'facet' => $thisFacet,
      'group' => $this->title,
      'moreClass' => false, // TODO: eliminate
      'url' => $this->results->getUrlQuery(),
      'urlBase' => '',
    ]) ?>
  <?php endforeach; ?>
</div>

<?php /* LESS and SEE MORE links */ ?>
<?php if (isset($i) && $i >= $this->facets_before_more): ?>
  <?php if ($this->showMoreInLightbox === 'more' && $facetLightbox = $options->getFacetListAction()): ?>
    <?php
      $moreUrl = $this->url($facetLightbox) . $results->getUrlQuery()->getParams() . '&amp;facet=' . $this->title . '&amp;facetop=' . $thisFacet['operator'] . '&amp;facetexclude=' . ($this->allowExclude ? 1 : 0);
      if (!empty($this->baseUriExtra)) {
        $moreUrl .= '&amp;baseUriExtra=' . urlencode($this->baseUriExtra);
      }
    ?>
    <a class="facet narrow-toggle <?=$moreClass ?? '' ?>" data-lightbox href="<?=$moreUrl ?>" rel="nofollow">
      <span class="text"><?=$this->transEsc('see all')?> ...</span>
    </a>
  <?php endif; ?>
<?php endif; ?>
