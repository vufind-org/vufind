<!-- START of: finna - RecordDriver/DefaultRecord/result-online-urls.phtml -->
  <?php
    $openUrl = $this->openUrl($this->driver, 'results');
    $openUrlActive = $openUrl->isActive();

    $images = $this->record($this->driver)->getAllRecordImageUrls();
    $urls = $this->driver->getURLs();
    $onlineURLs = $this->driver->tryMethod('getOnlineURLs');
    $mergedData = $this->driver->tryMethod('getMergedRecordData');

    if (!empty($images)
      && !$this->record($this->driver)->containsNonImageURL($urls, $images)
      && !$this->record($this->driver)->containsNonImageURL($onlineURLs, $images)
      && !$this->record($this->driver)->containsPdfUrl($onlineURLs)
      && (empty($mergedData['urls']) || !$this->record($this->driver)->containsNonImageURL($mergedData['urls'], $images))
      && !$openUrlActive
    ) {
       // Some onlineurls might be links to pdf files, but otherwise they are imageurls
       return;
    }
    $videoScripts = $this->partial('Helpers/videojs-urls.phtml');

    $urlBase = [
      'class' => 'fulltext',
      'target' => '_blank'
    ];
    $this->htmlElement()->addAttributeTemplate('url-base', $urlBase);
  ?>

  <?php if (!empty($urls) || $openUrlActive || !empty($onlineURLs) || !empty($mergedData['urls'])): ?>
    <div class="available-online-links">
      <strong class="available-online-header <?=(!empty($onlineURLs) || !empty($mergedData['urls']) || !empty($urls)) ? '' : 'hidden'; ?>"><?=$this->transEsc('Available Online') ?>:</strong>
      <div class="truncate-field">
      <?php $renderedURLs = []; ?>
      <?php if (!empty($urls)): ?>
        <?php foreach ($urls as $i => $url): ?>
          <?php
            if (isset($images[$url['url']]) && strcasecmp(pathinfo($url['url'], PATHINFO_EXTENSION), 'pdf') !== 0) {
              continue;
            } else {
              $renderedURLs[] = $url['url'];
            }
          ?>
          <?=$i > 0 ? '<br/>' : '' ?>
          <?php
            $currentUrl = [
              'href' => $this->proxyUrl($url['url']),
              'title' => $url['url']
            ];
            if (!empty($url['videoSources'])) {
              $videoData = [
                'data-video-sources' => json_encode($url['videoSources']),
                'data-scripts' => $videoScripts
              ];
              $currentUrl = array_merge($currentUrl, $videoData);
            }
            if (!empty($url['posterUrl'])) {
              $currentUrl['data-poster-url'] = $url['posterUrl'];
            }
            if (!empty($url['embed']) && $url['embed'] === 'video') {
              $currentUrl['data-embed-video'] = '';
            }
          ?>
          <a <?= $this->htmlElement()->getAttributes($currentUrl, 'url-base') ?>><i class="fa fa-external-link"aria-hidden="true"></i>
            <?=!empty($url['desc']) ? $this->transEsc('default::link_' . $url['desc'], null, $url['desc']) : $this->truncateUrl($url['url']) ?>
          </a>
          <?php if (!empty($url['part'])): ?> <span class="coverage"><?=$this->transEsc('default::link_' . $url['part'], null, $url['part']) ?></span><?php endif; ?>
        <?php endforeach; ?>
      <?php endif; ?>

      <?php if (!empty($onlineURLs) || !empty($mergedData['urls'])): ?>
        <?php foreach (!empty($mergedData['urls']) ? $mergedData['urls'] : $onlineURLs as $i => $url): ?>
          <?php
            if (isset($images[$url['url']]) || in_array($url['url'], $renderedURLs))
            {
              continue;
            }
            $currentUrl = [
              'href' => $this->proxyUrl($url['url']),
              'title' => $url['url'],
            ];
            if (!empty($url['embed']) && $url['embed'] === 'iframe') {
              $currentUrl['data-embed-iframe'] = '';
            }
          ?>
          <?=count($renderedURLs) || $i > 0 ? '<br/>' : '' ?>
          <a <?= $this->htmlElement()->getAttributes($currentUrl, 'url-base') ?>><i class="fa fa-external-link" aria-hidden="true"></i>
            <?=!empty($url['text']) ? $this->transEsc('default::link_' . $url['text'], null, $url['text']) : $this->escapeHtml($this->truncateUrl($url['url'])) ?>
          </a>
          <?php if (!empty($url['part'])): ?> <span class="coverage"><?=$this->transEsc('default::link_' . $url['part'], null, $url['part']) ?></span><?php endif; ?>
          <?php if ($url['source']): ?>
            <span class="online-source">(<?=is_array($url['source']) ? $this->transEsc('Multiple Organisations') : $this->transEsc('default::source_' . $url['source'], null, $url['source']) ?>)</span>
          <?php endif; ?>
        <?php endforeach; ?>
      <?php endif; ?>
      </div>
    <?php if ($openUrlActive): ?>
      <?=$openUrl->renderTemplate()?>
    <?php endif; ?>
    </div>
  <?php endif; ?>
<!-- END of: finna - RecordDriver/DefaultRecord/result-online-urls.phtml -->
