function ajaxLogin(e){Lightbox.ajax({url:path+"/AJAX/JSON?method=getSalt",dataType:"json",success:function(t){if(t.status=="OK"){var n=t.data;var r=e.password.value;r=rc4Encrypt(n,r);r=hexEncode(r);var i={password:r};for(var s=0;s<e.length;s++){if(e.elements[s].name=="password"){continue}i[e.elements[s].name]=e.elements[s].value}Lightbox.ajax({type:"POST",url:path+"/AJAX/JSON?method=login",dataType:"json",data:i,success:function(e){if(e.status=="OK"){$("#loginOptions").hide();$(".logoutOptions").show();var t=$("#record_id").val();if(typeof checkSaveStatuses=="function"){checkSaveStatuses()}$(".commentList").each(function(){var e=extractSource($("#record"));refreshCommentList(t,e)});var n=false;$(".hiddenSource").each(function(e,t){if(t.value=="Summon"){n=true;Lightbox.addCloseAction(function(){document.location.reload(true)})}});var r=$(".recordTabs");if(!n&&r.length>0){var i=r.find(".active a").attr("id");$.ajax({type:"POST",url:path+"/AJAX/JSON?method=get&submodule=Record&subaction=AjaxTab&id="+t,data:{tab:i},success:function(e){r.next(".tab-container").html(e)},error:function(e,t){console.log(e,t)}})}if(Lightbox.lastPOST&&Lightbox.lastPOST["loggingin"]){Lightbox.close()}else{Lightbox.getByUrl(Lightbox.lastURL,Lightbox.lastPOST,Lightbox.changeContent)}}else{Lightbox.displayError(e.data)}}})}else{Lightbox.displayError(t.data)}}})}var Lightbox={lastURL:false,lastPOST:false,shown:false,XHR:false,openStack:[],closeStack:[],formHandlers:[],formCallbacks:[],addOpenAction:function(e){this.openStack.push(e)},addCloseAction:function(e){this.closeStack.push(e)},addFormHandler:function(e,t){this.formHandlers[e]=t},addFormCallback:function(e,t){this.formCallbacks[e]=t},ajax:function(e){this.XHR.abort();this.XHR=$.ajax(e)},changeContent:function(e,t){var n=$("#modal .modal-header");if(typeof t!=="undefined"){n.html(t)}if(n.find("h3").html().length==0){n.css("border-bottom-width","0")}else{n.css("border-bottom-width","1px")}$("#modal .modal-body").html(e).modal({show:true,backdrop:false});Lightbox.openActions()},close:function(e){$("#modal").modal("hide")},closeActions:function(){Lightbox.shown=false;while(Lightbox.closeStack.length>0){var e=Lightbox.closeStack.pop();e()}if(this.XHR){this.XHR.abort()}$("#modal").removeData("modal");$("#modal").find(".modal-header h3").html("");$("#modal").find(".modal-body").html(vufindString.loading+"...");var t=$("#record_id").val();var n=$(".hiddenSource").val();if(typeof checkSaveStatuses==="function"){checkSaveStatuses()}if(typeof refreshCommentList==="function"){refreshCommentList(t,n)}var r=$("#tagList");if(r.length>0){r.empty();var i=path+"/AJAX/JSON?"+$.param({method:"getRecordTags",id:t,source:n});$.ajax({dataType:"json",url:i,success:function(e){if(e.status=="OK"){$.each(e.data,function(e,t){var n=path+"/Tag?"+$.param({lookfor:t.tag});var i=(e>0?", ":" ")+'<a href="'+htmlEncode(n)+'">'+htmlEncode(t.tag)+"</a> ("+htmlEncode(t.cnt)+")";r.append(i)})}else if(e.data&&e.data.length>0){r.append(e.data)}}})}},openActions:function(){for(var e=0;e<Lightbox.openStack.length;e++){Lightbox.openStack[e]()}},confirm:function(e){this.changeContent('<div class="alert alert-info">'+e+'</div><button class="btn" onClick="Lightbox.close()">'+vufindString["close"]+"</button>")},displayError:function(e){var t=$("#modal .modal-body .alert");if(t.length>0){$(t).html(e)}else{$("#modal .modal-body").prepend('<div class="alert alert-error">'+e+"</div>")}$(".icon-spinner").remove()},getByUrl:function(e,t,n){if(typeof n=="undefined"){console.log("UNDEFINED",e);n=this.changeContent}if(this.shown==false){$("#modal").modal("show");this.shown=true}this.XHR=$.ajax({type:"POST",url:e,data:t,success:function(e){n(e)},error:function(n,r){console.log(r,n);console.log(e,t)}});this.lastURL=e;this.lastPOST=t;return false},get:function(e,t,n,r,i){var s=path+"/AJAX/JSON?method=getLightbox&submodule="+e+"&subaction="+t;if(typeof n!=="undefined"&&n!=={}){s+="&"+$.param(n)}if(typeof r=="undefined"){r={}}return this.getByUrl(s,r,i)},getFormData:function(e){var t=e.find("*[name]");var n={};for(var r=0;r<t.length;r++){var i=t[r].name;var s=i.substring(i.length-2)=="[]";if(s&&!n[i.substring(0,i.length-2)]){n[i.substring(0,i.length-2)]=[]}if(t[r].type=="submit"){if($(t[r]).attr("clicked")=="true"){n[i]=t[r].value}}else if(t[r].type=="radio"){if(t[r].checked){if(s){var o=i.substring(0,i.length-2);n[o].push(t[r].value)}else{n[i]=t[r].value}}}else if($(t[r]).attr("type")!="checkbox"||t[r].checked){if(s){var u=i.substring(0,i.length-2);n[u].push(t[r].value)}else{n[i]=t[r].value}}}return n},submit:function(e,t){if(typeof t=="undefined"){t=this.close}var n=this.getFormData(e);var r=e.attr("method")&&e.attr("method").toUpperCase()=="POST";if(e.attr("action")){var i=e.attr("action").substring(e.attr("action").indexOf(path)+path.length+1);var s=i.split("?");i=i.split("/");var o=s.length>1?deparam(s[1]):n["id"]?{id:n["id"]}:{};if(r){this.get(i[0],i[i.length-1],o,n,t)}else{this.get(i[0],i[i.length-1],n,{},t)}}else if(r){this.getByUrl(this.lastURL,n,t)}else{this.getByUrl(this.lastURL,{},t)}$(this).find(".modal-body").html(vufindString.loading+"...")},registerEvents:function(){var e=$("#modal");$("#make-list").click(function(){var e=this.href.split("?");var t=deparam(e[1]);t["id"]="NEW";return Lightbox.get("MyResearch","EditList",t)});$(e).find(".checkbox-select-all").change(function(){$(this).closest(".modal-body").find(".checkbox-select-item").attr("checked",this.checked)});$(e).find(".checkbox-select-item").change(function(){if(!this.checked){$(this).closest(".modal-body").find(".checkbox-select-all").attr("checked",false)}});$(e).find("form input[type=submit]").click(function(){if(Lightbox.XHR){Lightbox.XHR.abort()}$("#modal .icon-spinner").remove();$(this).attr("clicked","true");$(this).after(' <i class="icon-spinner icon-spin"></i> ')})},registerForms:function(){var e=$("#modal").find("form");var t=$(e).attr("name");if(typeof t!=="undefined"&&typeof Lightbox.formHandlers[t]!=="undefined"){$(e).submit(Lightbox.formHandlers[t])}else if(typeof Lightbox.formCallbacks[t]!=="undefined"){$(e).submit(function(e){Lightbox.submit($(e.target),Lightbox.formCallbacks[t]);return false})}else{$(e).submit(function(e){Lightbox.submit($(e.target),Lightbox.close);return false})}}};$(document).ready(function(){Lightbox.addOpenAction(Lightbox.registerEvents);Lightbox.addOpenAction(Lightbox.registerForms);Lightbox.addFormCallback("newList",Lightbox.changeContent);Lightbox.addFormHandler("loginForm",function(e){ajaxLogin(e.target);return false});$("#modal").on("shown",Lightbox.openActions);$("#modal").on("hidden",Lightbox.closeActions);$(".modal-link,.help-link").click(function(){var e=$(this).attr("title");if(typeof e==="undefined"){e=$(this).html()}$("#modal .modal-header h3").html(e)})})